name: Update Journal Manifest

# Trigger whenever you push any .html under /journals/
on:
  push:
    paths:
      - 'journals/*.html'

jobs:
  regenerate_manifest:
    runs-on: ubuntu-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v3

    - name: Generate journal manifest.json
      run: |
        # Start a brandâ€new array
        printf "[" > journals/manifest.json
        first=true
        # Loop over every .html file in journals/, sorted alphabetically
        for f in journals/*.html; do
          name=$(basename "$f")
          date="${name%.html}"
          if [ "$first" = true ]; then
            first=false
          else
            # Add a comma before every object except the first
            echo "," >> journals/manifest.json
          fi
          # Insert an object with filename, date, and an empty summary
          echo "{\"filename\": \"$name\", \"date\": \"$date\", \"summary\": \"\"}" >> journals/manifest.json
        done
        # Close the JSON array
        printf "]" >> journals/manifest.json

    - name: Commit updated manifest.json
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add journals/manifest.json
        # If there are no changes, this commit step will do nothing
        git commit -m "Auto-update journals/manifest.json" || echo "No changes to commit"

    - name: Push changes
      run: |
        git push